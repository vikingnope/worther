name: Check PR Author Bot Status

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
        description: 'The pull request number to check'
      event_type:
        required: true
        type: string
        description: 'The event type (pull_request or issue_comment)'
    outputs:
      is_bot:
        description: 'Whether the PR author is a bot'
        value: ${{ jobs.check-bot-author.outputs.is_bot }}
      is_dependabot:
        description: 'Whether the PR author is specifically Dependabot'
        value: ${{ jobs.check-bot-author.outputs.is_dependabot }}
      is_excluded_bot:
        description: 'Whether the PR author is an excluded bot (should skip all checks)'
        value: ${{ jobs.check-bot-author.outputs.is_excluded_bot }}

jobs:
  check-bot-author:
    name: üîç Check PR Author
    runs-on: ubuntu-latest
    outputs:
      is_bot: ${{ steps.check-bot.outputs.is_bot }}
      is_dependabot: ${{ steps.check-bot.outputs.is_dependabot }}
      is_excluded_bot: ${{ steps.check-bot.outputs.is_excluded_bot }}
    steps:
      - uses: actions/checkout@v4.2.2

      - name: Load bot patterns
        id: load-patterns
        uses: ./.github/actions/load-bot-patterns

      - name: Check if PR author is a bot
        id: check-bot
        uses: actions/github-script@v7.0.1
        with:
          script: |
            ${{ steps.load-patterns.outputs.bot-patterns-script }}

            let prAuthor;
            let prNumber;

            // Handle different event types
            if (context.payload.pull_request) {
              // For direct PR events
              prAuthor = context.payload.pull_request.user.login;
              prNumber = context.payload.pull_request.number;
              console.log(`Direct PR event: PR #${prNumber} by ${prAuthor}`);
            } else {
              // For comment-triggered events, fetch PR details using the provided number
              const inputPR = '${{ inputs.pr_number }}';
              if (!inputPR || isNaN(Number(inputPR))) {
                core.setFailed('Invalid or missing PR number input');
                return;
              }
              prNumber = Number(inputPR);
              console.log(`Comment-triggered event: Fetching PR #${prNumber} details`);
              
              try {
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });
                prAuthor = pr.user.login;
                console.log(`Fetched PR author: ${prAuthor}`);
              } catch (error) {
                console.error(`Error fetching PR details: ${error.message}`);
                core.setFailed(`Failed to fetch PR details: ${error.message}`);
                return;
              }
            }

            // Use the centralized bot detection functions
            const isBotResult = isBot(prAuthor);
            const isExcludedBotResult = isExcludedBot(prAuthor);
            const isDependabotResult = isDependabot(prAuthor);

            // Set outputs
            core.setOutput('is_bot', isBotResult.toString());
            core.setOutput('is_dependabot', isDependabotResult.toString());
            core.setOutput('is_excluded_bot', isExcludedBotResult.toString());

            console.log(`PR #${prNumber} Author: ${prAuthor}`);
            console.log(`Is Bot: ${isBotResult}`);
            console.log(`Is Dependabot: ${isDependabotResult}`);
            console.log(`Is Excluded Bot: ${isExcludedBotResult}`);

            // If this is an excluded bot, create a comment and exit gracefully
            if (isExcludedBotResult) {
              console.log(`Detected excluded bot: ${prAuthor}. Workflow will be skipped.`);
              
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `ü§ñ **Automated Bot Detected**: This PR is from \`${prAuthor}\`, which is an excluded bot. PR checks have been automatically skipped to avoid unnecessary workflow runs.`
                });
                console.log('Added comment about excluded bot detection');
              } catch (error) {
                console.log(`Could not add comment (this is normal): ${error.message}`);
              }
            }
