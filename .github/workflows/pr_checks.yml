name: Pull Request Checks

on:
  pull_request:
    types: [opened, reopened, synchronize, edited, ready_for_review, demilestoned]

# Add concurrency to cancel in-progress runs on new commits
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  #################################################
  # INITIAL CHECK - Author detection
  #################################################
  initial-author-check:
    name: üîç Initial PR Author Check
    runs-on: ubuntu-latest
    outputs:
      is_bot: ${{ steps.check-bot.outputs.is_bot }}
      is_dependabot: ${{ steps.check-bot.outputs.is_dependabot }}
    steps:
      - name: Check if PR author is a bot
        id: check-bot
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const prAuthor = context.payload.pull_request.user.login;

            // Check if the author is a bot (ends with [bot] or is dependabot)
            const isBot = prAuthor.endsWith('[bot]') || prAuthor.startsWith('dependabot');

            // Check specifically for Dependabot
            const isDependabot = prAuthor.startsWith('dependabot');

            // Set outputs
            core.setOutput('is_bot', isBot.toString());
            core.setOutput('is_dependabot', isDependabot.toString());

            console.log(`PR Author: ${prAuthor}`);
            console.log(`Is Bot: ${isBot}`);
            console.log(`Is Dependabot: ${isDependabot}`);

  #################################################
  # CHANGELOG CHECKS
  #################################################
  changelog-update-dependabot:
    name: üìù Update Changelog (Dependabot)
    needs: initial-author-check
    if: ${{ needs.initial-author-check.outputs.is_dependabot == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      changelog_updated: ${{ steps.extract-info.outputs.has_match }}
      package_name: ${{ steps.extract-info.outputs.package }}
      from_version: ${{ steps.extract-info.outputs.from_version }}
      to_version: ${{ steps.extract-info.outputs.to_version }}
      dep_type: ${{ steps.update-changelog.outputs.dep_type }}
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract dependency information
        id: extract-info
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Pattern for conventional commit format: build(deps): bump package from version to version
          if [[ "$PR_TITLE" =~ build\(deps.*\):\ bump\ ([^\ ]+)\ from\ ([0-9]+[\.0-9]*)\ to\ ([0-9]+[\.0-9]*) ]]; then
            PACKAGE="${BASH_REMATCH[1]}"
            FROM_VERSION="${BASH_REMATCH[2]}"
            TO_VERSION="${BASH_REMATCH[3]}"
            echo "package=$PACKAGE" >> $GITHUB_OUTPUT
            echo "from_version=$FROM_VERSION" >> $GITHUB_OUTPUT
            echo "to_version=$TO_VERSION" >> $GITHUB_OUTPUT
            echo "has_match=true" >> $GITHUB_OUTPUT
          else
            echo "has_match=false" >> $GITHUB_OUTPUT
          fi

      - name: Update CHANGELOG.md
        id: update-changelog
        if: steps.extract-info.outputs.has_match == 'true'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          CHANGELOG_FILE="public/CHANGELOG.md"
          PACKAGE="${{ steps.extract-info.outputs.package }}"
          FROM_VERSION="${{ steps.extract-info.outputs.from_version }}"
          TO_VERSION="${{ steps.extract-info.outputs.to_version }}"

          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "Error: CHANGELOG.md not found at $CHANGELOG_FILE"
            exit 1
          fi

          # Determine the type of dependency
          DEP_TYPE="dependency"
          if [[ "$PR_TITLE" == *"deps-dev"* ]]; then
            DEP_TYPE="dev dependency"
          fi
          echo "dep_type=$DEP_TYPE" >> $GITHUB_OUTPUT

          # Find the first version section line and the next section (if any)
          FIRST_VERSION_LINE=$(grep -n "^## " "$CHANGELOG_FILE" | head -1 | cut -d: -f1)
          NEXT_VERSION_LINE=$(grep -n "^---" "$CHANGELOG_FILE" | head -1 | cut -d: -f1)

          # If there's no next section (no "---" line found), insert before the end of the file
          if [ -z "$NEXT_VERSION_LINE" ]; then
            INSERT_LINE="$(($(wc -l < "$CHANGELOG_FILE")+1))"
          else
            # Insert right before the "---" separator
            INSERT_LINE="$((NEXT_VERSION_LINE-1))"
          fi

          # Format the changelog entry
          ENTRY="- Bump $DEP_TYPE $PACKAGE from $FROM_VERSION to $TO_VERSION"

          # Insert the entry before the separator line or at the end of file
          sed -i "${INSERT_LINE}i $ENTRY" "$CHANGELOG_FILE"

          # Commit and push the changes
          git config --local user.email "dependabot-changelog-updater[bot]@users.noreply.github.com"
          git config --local user.name "Dependabot Changelog Updater"
          git add "$CHANGELOG_FILE"
          git commit -m "docs: update changelog with $PACKAGE dependency bump"
          git push

      - name: Comment on PR about changelog update
        if: steps.extract-info.outputs.has_match == 'true'
        uses: actions/github-script@v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const packageName = '${{ steps.extract-info.outputs.package }}';
            const fromVersion = '${{ steps.extract-info.outputs.from_version }}';
            const toVersion = '${{ steps.extract-info.outputs.to_version }}';
            const depType = '${{ steps.update-changelog.outputs.dep_type }}';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üìù **Changelog Automatically Updated**\n\nA changelog entry has been automatically added for this Dependabot PR:\n\n- Bump ${depType} ${packageName} from ${fromVersion} to ${toVersion}`
            });

  changelog-check-user:
    name: üìã Check Changelog (User PR)
    needs: initial-author-check
    # Skip if it's a bot PR
    if: ${{ needs.initial-author-check.outputs.is_bot == 'false' }}
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.changelog-check.outputs.changed }}
    steps:
      - uses: actions/checkout@v4.2.2
      - name: Check for changelog changes
        id: changelog-check
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGELOG_CHANGED=$(git diff --name-only origin/${{ github.base_ref }} | grep -c "public/CHANGELOG.md" || true)
          echo "changed=$CHANGELOG_CHANGED" >> $GITHUB_OUTPUT

  changelog-enforce-user:
    name: ‚úÖ Enforce Changelog (User PR)
    needs: [initial-author-check, changelog-check-user]
    if: ${{ needs.initial-author-check.outputs.is_bot == 'false' }}
    runs-on: ubuntu-latest
    outputs:
      should_block: ${{ steps.check-status.outputs.should_block }}
    steps:
      - uses: actions/checkout@v4.2.2

      - name: Handle changelog enforcement
        id: check-status
        run: |
          HAS_CHANGES="${{ needs.changelog-check-user.outputs.has_changes }}"

          # Always try to remove the label first if changes exist
          if [[ "$HAS_CHANGES" != "0" ]]; then
            echo "Changelog changes detected - removing label if it exists"
            gh pr edit ${{ github.event.pull_request.number }} --remove-label "Changelog needed" 2>/dev/null || true
          fi

          # For non-bot PRs, check if changelog was updated
          if [[ "$HAS_CHANGES" == "0" ]]; then
            echo "User PR detected without changelog changes - blocking"
            gh label create "Changelog needed" --color FF0000 --description "Changelog update required" 2>/dev/null || true
            gh pr edit ${{ github.event.pull_request.number }} --add-label "Changelog needed"
            echo "should_block=true" >> $GITHUB_OUTPUT
          else
            echo "User PR detected with changelog changes - allowing"
            echo "should_block=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #################################################
  # CODE QUALITY CHECKS
  #################################################
  # For non-bot PRs - runs immediately
  quality-lint-format-user:
    needs: [initial-author-check]
    if: ${{ needs.initial-author-check.outputs.is_bot == 'false' }}
    uses: ./.github/workflows/lint_format.yml
    with:
      job-name: 'üßπ Code Quality Checks'

  # For bot PRs - waits for changelog update to finish
  quality-lint-format-bot:
    # Wait for changelog update to complete for bot PRs
    needs: [initial-author-check, changelog-update-dependabot]
    if: ${{ needs.initial-author-check.outputs.is_bot == 'true' }}
    uses: ./.github/workflows/lint_format.yml
    with:
      job-name: 'üßπ Code Quality Checks (Bot PR)'

  #################################################
  # PR METADATA CHECKS
  #################################################
  metadata-milestone-check:
    name: üè∑Ô∏è PR Milestone Check
    needs:
      - initial-author-check
      - quality-lint-format-user
      - quality-lint-format-bot
    # This ensures it only needs one of the two lint jobs to complete based on PR author type
    if: ${{ always() && !contains(needs.*.result, 'cancelled') }}
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR has milestone
        id: check-milestone
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;

            // Check if PR has a milestone
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });

            if (pr.data.milestone) {
              console.log(`PR #${prNumber} already has milestone: ${pr.data.milestone.title}`);
              return true;
            }

            // Get latest milestone
            const milestones = await github.rest.issues.listMilestones({
              owner,
              repo,
              state: 'open',
              sort: 'due_on',
              direction: 'desc'
            });

            if (milestones.data.length === 0) {
              console.log('No milestones found!');
              core.setFailed('No milestones available to add to PR');
              return false;
            }

            // Sort by creation date (newest first)
            const sortedMilestones = milestones.data.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );

            const latestMilestone = sortedMilestones[0];
            console.log(`Latest milestone: ${latestMilestone.title}`);

            // Update the PR with the latest milestone
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: prNumber,
              milestone: latestMilestone.number
            });

            // Add comment to PR
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `‚úÖ Automatically added milestone ${latestMilestone.title} to this pull request.`
            });

            console.log(`Added milestone ${latestMilestone.title} to PR #${prNumber}`);
            return true;

  #################################################
  # FINAL STATUS CHECK
  #################################################
  final-status:
    name: üö¶ Final Status Check
    needs:
      - initial-author-check
      - quality-lint-format-user
      - quality-lint-format-bot
      - metadata-milestone-check
      - changelog-update-dependabot
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Set job status variables
        id: set-status
        run: |
          IS_BOT="${{ needs.initial-author-check.outputs.is_bot }}"
          echo "is_bot=$IS_BOT" >> $GITHUB_OUTPUT

      # Show status report of all jobs
      - name: Generate status report
        run: |
          echo "## üìä PR Checks Status Report"
          echo ""
          echo "| Check | Status | Result |"
          echo "|-------|--------|--------|"
          echo "| üîç Initial Author Check | ${{ needs.initial-author-check.result }} | PR is by ${{ needs.initial-author-check.outputs.is_bot == 'true' && 'bot' || 'user' }} |"

          if [[ "${{ steps.set-status.outputs.is_bot }}" == "true" ]]; then
            echo "| üìù Update Changelog (Bot) | ${{ contains(github.event.pull_request.jobs, 'changelog-update-dependabot') && needs.changelog-update-dependabot.result || 'skipped' }} | ${{ needs.changelog-update-dependabot.outputs.changelog_updated == 'true' && 'Updated' || 'Not applicable' }} |"
            echo "| üßπ Code Quality (Bot) | ${{ needs.quality-lint-format-bot.result }} | - |"
          else
            echo "| üìã Check Changelog (User) | ${{ contains(github.event.pull_request.jobs, 'changelog-check-user') && needs.changelog-check-user.result || 'skipped' }} | Changes: ${{ needs.changelog-check-user.outputs.has_changes != '0' && 'Yes' || 'No' }} |"
            echo "| ‚úÖ Enforce Changelog | ${{ contains(github.event.pull_request.jobs, 'changelog-enforce-user') && needs.changelog-enforce-user.result || 'skipped' }} | Should block: ${{ needs.changelog-enforce-user.outputs.should_block }} |"
            echo "| üßπ Code Quality (User) | ${{ needs.quality-lint-format-user.result }} | - |"
          fi

          echo "| üè∑Ô∏è PR Milestone Check | ${{ needs.metadata-milestone-check.result }} | - |"

      # Split failure check to its own step with if condition
      - name: Check for job failures
        if: ${{ contains(needs.*.result, 'failure') }}
        run: |
          echo "‚õî One or more checks failed - blocking merge"

          # List which checks failed
          if [[ "${{ needs.initial-author-check.result }}" == "failure" ]]; then
            echo "- ‚ùå Initial author check failed"
          fi

          if [[ "${{ needs.metadata-milestone-check.result }}" == "failure" ]]; then
            echo "- ‚ùå Milestone check failed"
          fi

          if [[ "${{ steps.set-status.outputs.is_bot }}" == "true" ]]; then
            if [[ "${{ needs.quality-lint-format-bot.result }}" == "failure" ]]; then
              echo "- ‚ùå Code quality checks (bot) failed"
            fi
            if [[ "${{ contains(github.event.pull_request.jobs, 'changelog-update-dependabot') && needs.changelog-update-dependabot.result == 'failure' }}" == "true" ]]; then
              echo "- ‚ùå Changelog update for bot failed"
            fi
          else
            if [[ "${{ needs.quality-lint-format-user.result }}" == "failure" ]]; then
              echo "- ‚ùå Code quality checks (user) failed"
            fi
            if [[ "${{ contains(github.event.pull_request.jobs, 'changelog-check-user') && needs.changelog-check-user.result == 'failure' }}" == "true" ]]; then
              echo "- ‚ùå Changelog check failed"
            fi
            if [[ "${{ contains(github.event.pull_request.jobs, 'changelog-enforce-user') && needs.changelog-enforce-user.result == 'failure' }}" == "true" ]]; then
              echo "- ‚ùå Changelog enforcement failed"
            fi
          fi

          exit 1

      # Check for skipped jobs based on PR author type
      - name: Check for skipped jobs (non-bot PR)
        if: ${{ steps.set-status.outputs.is_bot == 'false' }}
        env:
          QUALITY_STATUS: ${{ needs.quality-lint-format-user.result }}
          MILESTONE_STATUS: ${{ needs.metadata-milestone-check.result }}
        run: |
          if [[ "$QUALITY_STATUS" == "skipped" || "$MILESTONE_STATUS" == "skipped" ]]; then
            echo "‚ö†Ô∏è Required checks were skipped - blocking merge"
            
            if [[ "$QUALITY_STATUS" == "skipped" ]]; then
              echo "- ‚ö†Ô∏è Code quality checks were skipped"
            fi
            
            if [[ "$MILESTONE_STATUS" == "skipped" ]]; then
              echo "- ‚ö†Ô∏è Milestone checks were skipped"
            fi
            
            exit 1
          fi

      - name: Check for skipped jobs (bot PR)
        if: ${{ steps.set-status.outputs.is_bot == 'true' }}
        env:
          BOT_QUALITY_STATUS: ${{ needs.quality-lint-format-bot.result }}
          MILESTONE_STATUS: ${{ needs.metadata-milestone-check.result }}
        run: |
          if [[ "$BOT_QUALITY_STATUS" == "skipped" || "$MILESTONE_STATUS" == "skipped" ]]; then
            echo "‚ö†Ô∏è Required checks were skipped - blocking merge"
            
            if [[ "$BOT_QUALITY_STATUS" == "skipped" ]]; then
              echo "- ‚ö†Ô∏è Bot code quality checks were skipped"
            fi
            
            if [[ "$MILESTONE_STATUS" == "skipped" ]]; then
              echo "- ‚ö†Ô∏è Milestone checks were skipped"
            fi
            
            exit 1
          fi

      - name: Success message
        run: |
          echo "‚úÖ All PR checks completed successfully"

          # Provide a summary of what was run
          if [[ "${{ steps.set-status.outputs.is_bot }}" == "true" ]]; then
            echo "Bot PR detected - ran bot-specific workflows"
            echo "- ‚úì Initial author check (completed)"
            echo "- ‚úì Bot code quality check (completed)"
            echo "- ‚úì Milestone check (completed)"
            if [[ "${{ contains(github.event.pull_request.jobs, 'changelog-update-dependabot') }}" == "true" ]]; then
              echo "- ‚úì Changelog auto-update (completed)"
            fi
          else
            echo "User PR detected - ran user-specific workflows"
            echo "- ‚úì Initial author check (completed)"
            echo "- ‚úì User code quality check (completed)"
            echo "- ‚úì Milestone check (completed)"
            if [[ "${{ contains(github.event.pull_request.jobs, 'changelog-check-user') }}" == "true" ]]; then
              echo "- ‚úì Changelog check (completed)"
            fi
          fi
